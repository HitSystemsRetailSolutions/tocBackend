"use strict";(self["webpackChunktoc_game_v4"]=self["webpackChunktoc_game_v4"]||[]).push([[509],{48466:function(a,e,o){o.d(e,{Z:function(){return h}});var t=o(73396),l=o(87139);const i={class:"container"},n={key:0,class:"h3 text-center"},r={key:1,class:"h3 text-center"},c={key:2,class:"h3 text-center"},s={class:"row mt-2 container botonesCaja"},u={class:"again py-5"},d={class:"again py-5"},v={class:"again py-5"},m={class:"again py-5"};function p(a,e,o,p,k,_){const f=(0,t.up)("MDBBtn"),T=(0,t.up)("MDBModalBody"),g=(0,t.up)("MDBModal");return(0,t.wg)(),(0,t.j4)(g,{id:"ModalErrorDatafonoQueHacerComponent",tabindex:"-1",labelledby:"tituloModalDatafono",modelValue:p.ModalErrorDatafonoQueHacerComponent,"onUpdate:modelValue":e[4]||(e[4]=a=>p.ModalErrorDatafonoQueHacerComponent=a),staticBackdrop:"",size:"lg"},{default:(0,t.w5)((()=>[(0,t.Wm)(T,null,{default:(0,t.w5)((()=>[(0,t._)("div",i,[1==p.ticketExist?((0,t.wg)(),(0,t.iD)("p",n," Se ha cobrado el pago con datáfono pero no nos ha llegado. ¿Que hacemos? ")):(0,t.kq)("",!0),2==p.ticketExist?((0,t.wg)(),(0,t.iD)("p",r," No se ha cobrado el pago con datáfono. ¿Que hacemos? ")):(0,t.kq)("",!0),3==p.ticketExist?((0,t.wg)(),(0,t.iD)("p",c," Ultimo pago fallido ¿Que hacemos? ")):(0,t.kq)("",!0)]),(0,t._)("div",s,[1==p.ticketExist?((0,t.wg)(),(0,t.j4)(f,{key:0,color:"success",size:"1g",class:"botonEstado my-3 botones",onClick:e[0]||(e[0]=a=>p.darComoValido())},{default:(0,t.w5)((()=>[(0,t._)("span",u,(0,l.zw)(a.$t("volver_a_cobrar","Pago válido con tarjeta")),1)])),_:1})):(0,t.kq)("",!0),p.ticketExist>1?((0,t.wg)(),(0,t.j4)(f,{key:1,color:"warning  ",class:"botonEstado my-3 botones",disabled:p.esperandoConexion?"":a.disabled,onClick:e[1]||(e[1]=a=>{p.tarjetaUltimoTicket(),p.esperandoConexion=!0})},{default:(0,t.w5)((()=>[(0,t._)("span",d,(0,l.zw)(a.$t("reintentar_pago","Reintentar pago con tarjeta")),1)])),_:1},8,["disabled"])):(0,t.kq)("",!0),p.ticketExist>1?((0,t.wg)(),(0,t.j4)(f,{key:2,color:"primary  ",class:"botonEstado my-3 botones",onClick:e[2]||(e[2]=a=>p.pagoDependienta())},{default:(0,t.w5)((()=>[(0,t._)("span",v,(0,l.zw)(a.$t("pago en efectivo","Pago en efectivo o 3G")),1)])),_:1})):(0,t.kq)("",!0),p.ticketExist>2?((0,t.wg)(),(0,t.j4)(f,{key:3,color:"danger ",class:"botonEstado my-3 botones",onClick:e[3]||(e[3]=a=>p.esborrarTicket())},{default:(0,t.w5)((()=>[(0,t._)("span",m,(0,l.zw)(a.$t("anular","Anular ticket")),1)])),_:1})):(0,t.kq)("",!0)])])),_:1})])),_:1},8,["modelValue"])}o(57658);var k=o(20065),_=o(91076),f=o(74313),T=o(42492),g=o.n(T),w=o(44870),A={name:"ModalErrorDatafonoQueHacerComponent",components:{MDBModal:f.j3,MDBModalBody:f.Yz,MDBBtn:f.$v},setup(a,{expose:e}){const o=(0,w.iH)(null),l=(0,w.iH)(0),i=(0,w.iH)(!1),n=(0,k.oR)(),r=(0,w.iH)(!1),c=(0,t.Fl)((()=>n.state.Trabajadores.arrayTrabajadores));let s=(0,w.iH)(!1);const u=(0,t.Fl)((()=>n.state.Trabajadores.indexActivo)),d=(0,t.Fl)((()=>c.value&&void 0!=u.value&&null!=u.value&&c.value[u.value]?c.value[u.value]:null));function v(a,e){if(4==e)return g().fire({icon:"success",title:"¡Todo ha salido correctamente!",showConfirmButton:!1,timer:1200});o.value=a,l.value=e,r.value=!0}async function m(){await _.Z.post("paytef/darPorValidoUltimoTicket",{idTrabajador:d.value._id}).then((()=>{r.value=!1,n.dispatch("Datafono/setEstado","APROBADA")})).catch((a=>{r.value=!0,g().fire("Oops...",a.message,"error")})),g().fire({icon:"success",title:"Pagado validado.",showConfirmButton:!1,timer:1200})}async function p(){null!=o.value&&(await T()?_.Z.post("tickets/anularTicket",{ticketId:o.value}).then((a=>{r.value=!1,a.data.res&&["EFECTIVO","DATAFONO_3G"].includes(a.data.tipo)?(i.value&&f(),g().fire({icon:"success",title:"Ticket anulado"+(i.value?" - imprimiendo ticket...":""),showConfirmButton:!1,timer:1200})):a.data.res?router.push("/main"):g().fire({icon:"error",title:"Ya esta anulado",showConfirmButton:!1,timer:1400})})).catch((a=>{g().fire(a.message)})):g().fire("No se ha anulado el ticket.","El ticket sigue activo.","info"))}function f(){_.Z.post("impresora/imprimirTicket",{idTicket:arrayTickets.value[indexTicket.value]._id}).catch((a=>{g().fire("Oops...",a.message,"error")}))}async function T(){return await g().fire({title:"¿Desea realmente anular el ticket? ",html:"Esta opción dejara el ticket anulado.",showCancelButton:!0,confirmButtonText:"Anular",cancelButtonText:"Cancelar",confirmButtonColor:"red",cancelButtonColor:"green",iconColor:"red",icon:"warning"}).then((async a=>!!a.isConfirmed))}function A(){s.value=!0,_.Z.post("paytef/cobrarUltimoTicket",{idTrabajador:d.value._id}).then((()=>{r.value=!1,s.value=!1,n.dispatch("Datafono/setEstado","PENDIENTE")})).catch((a=>{s.value=!1,r.value=!0,g().fire("Oops...",a.message,"error")})),s.value=!1,g().fire({icon:"success",title:"Pago enviado al datáfono",showConfirmButton:!1,timer:1200})}function y(){g().fire({icon:"success",title:"Pagado en efectivo",showConfirmButton:!1,timer:1200}),r.value=!1}return e({abrirModal:v}),(0,t.bv)((async()=>{const{data:a}=await _.Z.post("parametros/getParametros");i.value="Si"==a.params?.TicketAlAnular})),{store:n,darComoValido:m,ModalErrorDatafonoQueHacerComponent:r,tarjetaUltimoTicket:A,esperandoConexion:s,TicketAlAnular:i,arrayTrabajadores:c,indexTrabajadorActivo:u,esborrarTicket:p,idSeleccionado:o,pagoDependienta:y,ticketExist:l}}},y=o(40089);const C=(0,y.Z)(A,[["render",p],["__scopeId","data-v-266e01f8"]]);var h=C},99949:function(a,e,o){o.r(e),o.d(e,{default:function(){return ka}});var t=o(73396),l=o(87139);const i=a=>((0,t.dD)("data-v-61a97d2f"),a=a(),(0,t.Cn)(),a),n={class:"col-md-7 listaTickets"},r={class:"th-sm"},c={class:"th-sm"},s={class:"th-sm"},u={class:"th-sm"},d=["onClick"],v={key:0,class:"col-md-5"},m={id:"detalleTicket"},p={class:"text-center"},k={class:"text-center"},_=i((()=>(0,t._)("br",null,null,-1))),f=i((()=>(0,t._)("hr",null,null,-1))),T={class:"contencionTicket"},g={class:"table"},w={class:"titulosTicket"},A={class:"titulosTicket"},y={class:"titulosTicket"},C=i((()=>(0,t._)("hr",null,null,-1))),h={class:"text-center"};function b(a,e,o,i,b,D){const E=(0,t.up)("MDBTable"),M=(0,t.up)("MDBIcon"),x=(0,t.up)("MDBBtn"),B=(0,t.up)("CashlogyAnulacionView"),P=(0,t.up)("ModalAnulacionTicket");return(0,t.wg)(),(0,t.iD)(t.HY,null,[(0,t._)("div",n,[(0,t.Wm)(E,{hover:""},{default:(0,t.w5)((()=>[(0,t._)("thead",null,[(0,t._)("tr",null,[(0,t._)("th",r,(0,l.zw)(a.$t("numero_ticket","Número ticket")),1),(0,t._)("th",c,(0,l.zw)(a.$t("hora","Hora")),1),(0,t._)("th",s,(0,l.zw)(a.$t("tipo_pago","Tipo pago")),1),(0,t._)("th",u,(0,l.zw)(a.$t("total","Total")),1)])]),(0,t._)("tbody",null,[((0,t.wg)(!0),(0,t.iD)(t.HY,null,(0,t.Ko)(i.arrayTickets,((a,e)=>((0,t.wg)(),(0,t.iD)("tr",{key:e,class:(0,l.C_)({"table-active":a._id===i.idActivo}),onClick:o=>i.setActivo(a,e)},[(0,t._)("td",null,(0,l.zw)(a._id),1),(0,t._)("td",null,(0,l.zw)(i.getTiempo(a.timestamp)),1),(0,t._)("td",null,(0,l.zw)(a.tipoPago),1),(0,t._)("td",null,(0,l.zw)(a.total.toFixed(2))+" €",1)],10,d)))),128))])])),_:1})]),null!=i.indexTicket?((0,t.wg)(),(0,t.iD)("div",v,[(0,t._)("div",m,[(0,t._)("h2",p,(0,l.zw)(a.$t("ticket","Ticket"))+" "+(0,l.zw)(i.arrayTickets[i.indexTicket]._id),1),(0,t._)("h6",k,(0,l.zw)(i.getTiempo(i.arrayTickets[i.indexTicket].timestamp)),1),_,f,(0,t._)("div",T,[(0,t._)("table",g,[(0,t._)("tr",null,[(0,t._)("th",w,(0,l.zw)(a.$t("producto","Producto")),1),(0,t._)("th",A,(0,l.zw)(a.$t("subtotal","Subtotal")),1),(0,t._)("th",y,(0,l.zw)(a.$t("unidades","Unidades")),1)]),((0,t.wg)(!0),(0,t.iD)(t.HY,null,(0,t.Ko)(i.arrayTickets[i.indexTicket]?.cesta?.lista,((a,e)=>((0,t.wg)(),(0,t.iD)("tr",{key:e},[(0,t._)("td",null,(0,l.zw)(a.nombre),1),(0,t._)("td",null,(0,l.zw)(a.subtotal.toFixed(2))+" €",1),(0,t._)("td",null,(0,l.zw)(a.unidades),1)])))),128))])]),C,(0,t._)("h1",h,(0,l.zw)(a.$t("total","Total"))+": "+(0,l.zw)(i.arrayTickets[i.indexTicket].total.toFixed(2)),1),(0,t.Wm)(x,{onClick:e[0]||(e[0]=a=>i.imprimirTicket()),color:"success",class:"w-100"},{default:(0,t.w5)((()=>[(0,t.Wm)(M,{icon:"print",size:"3x"})])),_:1}),"DATAFONO_3G"!==i.arrayTickets[i.indexTicket].tipoPago&&"TARJETA"===i.arrayTickets[i.indexTicket].tipoPago||"DEVUELTO"===i.arrayTickets[i.indexTicket].tipoPago||"DEV_DATAFONO_PAYTEF"===i.arrayTickets[i.indexTicket].tipoPago?((0,t.wg)(),(0,t.j4)(x,{key:0,onClick:e[1]||(e[1]=a=>i.imprimirTicketPaytef()),color:"info",class:"w-100 mt-3"},{default:(0,t.w5)((()=>[(0,t.Wm)(M,{icon:"file-invoice-dollar",size:"3x"})])),_:1})):(0,t.kq)("",!0),"EFECTIVO"===i.arrayTickets[i.indexTicket].tipoPago?((0,t.wg)(),(0,t.j4)(x,{key:1,color:"primary",class:"w-100 mt-4",size:"lg",onClick:e[2]||(e[2]=a=>i.cambiarTipoPago(i.arrayTickets[i.indexTicket]._id))},{default:(0,t.w5)((()=>[(0,t.Uk)((0,l.zw)(a.$t("pagar_con_tarjeta","Pagar con tarjeta")),1)])),_:1})):(0,t.kq)("",!0),"DATAFONO_3G"===i.arrayTickets[i.indexTicket].tipoPago?((0,t.wg)(),(0,t.j4)(x,{key:2,color:"primary",class:"w-100 mt-4",size:"lg",onClick:e[3]||(e[3]=a=>i.pagarEfectivo(i.arrayTickets[i.indexTicket]._id))},{default:(0,t.w5)((()=>[(0,t.Uk)((0,l.zw)(a.$t("pagar_con_efectivo","Pagar con efectivo")),1)])),_:1})):(0,t.kq)("",!0),i.prohibirAnularTicket||"DATAFONO_3G"===i.arrayTickets[i.indexTicket].tipoPago&&i.prohibirAnular3g||"ANULADO"==i.arrayTickets[i.indexTicket].tipoPago||"DEVUELTO"==i.arrayTickets[i.indexTicket].tipoPago||!i.mostrarPorAlbaran?(0,t.kq)("",!0):((0,t.wg)(),(0,t.j4)(x,{key:3,onClick:e[4]||(e[4]=a=>i.openModalAnulacion(i.arrayTickets[i.indexTicket]._id)),disabled:i.anulando,color:"danger",class:"w-100 mt-4",size:"lg"},{default:(0,t.w5)((()=>[(0,t.Uk)((0,l.zw)(a.$t("devolucion_con_tarjeta_efectivo","Devolución con tarjeta/efectivo")),1)])),_:1},8,["disabled"]))])])):(0,t.kq)("",!0),(0,t.Wm)(B,{ref:"CashlogyAnulacionViewRef"},null,512),(0,t.Wm)(P,{ref:"modalAnulacionTicketRef",onAnularTicket:i.esborrarTicket},null,8,["onAnularTicket"])],64)}o(57658);var D=o(74834),E=o(74313),M=o(44870),x=o(20065),B=o(36797),P=o.n(B),O=o(91076),U=o(42492),R=o.n(U),I=o(92136),H=o(6411),N=o(48466),z=o(12195),L=o(74025),V=o(68315),Z=o(13150),j=o(16683),S=o(34730),W=o(88807);const $={key:0,class:"frame-Cashlogy flex-column"},F={class:"d-flex flex-column",style:{gap:"2px"}},q={key:1,class:"frame-Cashlogy flex-column"},Y={class:"d-flex flex-column",style:{gap:"2px"}},G=(0,t._)("span",null,"Falta cambios para la devolución",-1),Q={key:2,class:"frame-Cashlogy flex-column"},J={class:"d-flex flex-column",style:{gap:"2px"}},K={key:3,class:"frame-Cashlogy flex-column"},X=(0,t._)("br",null,null,-1);var aa={__name:"CashlogyAnulacionView",setup(a,{expose:e}){const o=(0,M.iH)(null),i=(0,M.iH)(null),n=(0,M.iH)(""),r=(0,M.iH)(""),c=(0,M.iH)(""),s=(0,M.iH)(!1),u=(0,M.iH)(!1);async function d(){return Z.Z.activado()}const v=(0,M.iH)({}),m=new j.JQ((a=>{n.value=(0,j.vg)(a.importe_a_devolver,!0),_.value="PANTALLA_SELECCIONAR_TIPO"})),p=new j.JQ((a=>{n.value=(0,j.vg)(a.importe_falta_devolver,!0),u.value=a.opcion_cancelar,_.value="PANTALLA_FALTA_CAMBIO_DEVOLUCION"}));function k(){s.value=!0,Z.Z.boton_pulsar("BOT_ACEPTAR")}const _=(0,M.iH)(null);function f(a){I.socket[a]("Cashlogy.update",T)}function T(a){switch(_.value=a.proceso,a.proceso){case"AÑADIR_CAMBIOS":v.value=(0,j.c)(a),r.value=(0,j.vg)(a.importe_entrado,!0),c.value=(0,j.vg)(a.importe_recicladores,!0);break;case"SOLO_DISPENSAR":n.value=(0,j.vg)(a.importe_a_devolver,!0);break}}let g=!1;async function w(a){let e;if(g=!0,_.value=null,W.Z.Info({importe_a_devolver:a},"CashlogyAnulacionView","run-in"),await(0,j.R_)(o),o.value.texto_botones_para_abort("DEVOLVER MANUALMENTE","CANCELAR DEVOLUCIÓN"),e=await o.value.start(),e)return W.Z.Info(e,"CashlogyAnulacionView","run-out"),g=!1,e;f("on");try{let[t,l]=await o.value.startPantalla_withReset(m,{importe_a_devolver:a});if(l)e=l;else if("CASHLOGY"==t&&0==a&&(t="MANUAL"),"CASHLOGY"==t){_.value=null,await Z.Z.saveGrupoProcesos("ANULACION",{importe_a_devolver:a});let t=await Z.Z.solo_dispensar(a);e=await(o.value?.informacionAbort_y_cancel(t));let l=t.importe_falta_devolver??0,n=0,r=t.error_en_la_devolucion;while(!e){if(_.value="ERROR_DEVOLUCION",await(0,j.R_)(i),await i.value.run({error_en_la_devolucion:r}),0==l){e={importe_falta_devolver:0,importe_anadido_en_cambios:n};break}let[t,c]=await o.value.startPantalla_withReset(p,{importe_falta_devolver:l,opcion_cancelar:l==a});if(c)e=c;else if("AÑADIR"==t){_.value=null,s.value=!1;let a=await Z.Z.anadir_cambios_y_devolver(l);e=await(o.value?.informacionAbort_y_cancel(a)),e?e.importe_falta_devolver=l:(r=a.error_en_la_devolucion,l=a.importe_falta_devolver,n+=a.importe_anadido_en_cambios,await Z.Z.saveGrupoProcesos(null,{importe_anadido_en_cambios:n}))}else e="CANCELAR"==t?{cancelado:!0,importe_falta_devolver:l,importe_anadido_en_cambios:n}:{manual:!0,importe_falta_devolver:l,importe_anadido_en_cambios:n}}}else e="CANCELAR"==t?{cancelado:!0}:{manual:!0};e.abort_id||(await Z.Z.saveGrupoProcesos(null),await(0,S.i_)(e.importe_anadido_en_cambios,"Añadir Cambios","ENTRADA_DINERO"))}catch(t){console.log(t),e={cancelado:!0}}return f("off"),o.value?.end(),W.Z.Info(e,"CashlogyAnulacionView","run-out"),g=!1,e}return(0,t.Ah)((()=>{g&&Z.Z.boton_pulsar("BOT_ABORTAR_Y_CANCELAR")})),e({run:w,activado:d}),(a,e)=>((0,t.wg)(),(0,t.j4)(V.Z,{enProceso:null!=_.value,ref_key:"CashlogyPantalla_ref",ref:o},{default:(0,t.w5)((()=>["PANTALLA_SELECCIONAR_TIPO"==_.value?((0,t.wg)(),(0,t.iD)("div",$,[(0,t._)("div",F,[(0,t.Wm)((0,M.SU)(E.$v),{onClick:e[0]||(e[0]=a=>(0,M.SU)(m).R("CASHLOGY")),color:"success",class:"boton-Cashlogy"},{default:(0,t.w5)((()=>[(0,t.Uk)(" Devolución con Cashlogy ")])),_:1}),(0,t.Wm)((0,M.SU)(E.$v),{onClick:e[1]||(e[1]=a=>(0,M.SU)(m).R("MANUAL")),color:"warning",class:"boton-Cashlogy"},{default:(0,t.w5)((()=>[(0,t.Uk)(" devolucion manual ")])),_:1}),(0,t.Wm)((0,M.SU)(E.$v),{onClick:e[2]||(e[2]=a=>(0,M.SU)(m).R("CANCELAR")),color:"danger",class:"boton-Cashlogy"},{default:(0,t.w5)((()=>[(0,t.Uk)(" cancelar ")])),_:1})])])):(0,t.kq)("",!0),"PANTALLA_FALTA_CAMBIO_DEVOLUCION"==_.value?((0,t.wg)(),(0,t.iD)("div",q,[(0,t._)("div",Y,[G,(0,t._)("span",null,"Importe falta devolver: "+(0,l.zw)(n.value),1),(0,t.Wm)((0,M.SU)(E.$v),{onClick:e[3]||(e[3]=a=>(0,M.SU)(p).R("AÑADIR")),color:"success",class:"boton-Cashlogy"},{default:(0,t.w5)((()=>[(0,t.Uk)(" añadir cambios ")])),_:1}),(0,t.Wm)((0,M.SU)(E.$v),{onClick:e[4]||(e[4]=a=>(0,M.SU)(p).R("MANUAL")),color:"warning",class:"boton-Cashlogy"},{default:(0,t.w5)((()=>[(0,t.Uk)(" devolucion manual ")])),_:1}),u.value?((0,t.wg)(),(0,t.j4)((0,M.SU)(E.$v),{key:0,onClick:e[5]||(e[5]=a=>(0,M.SU)(p).R("CANCELAR")),color:"danger",class:"boton-Cashlogy"},{default:(0,t.w5)((()=>[(0,t.Uk)(" cancelar ")])),_:1})):(0,t.kq)("",!0)])])):(0,t.kq)("",!0),"AÑADIR_CAMBIOS"==_.value?((0,t.wg)(),(0,t.iD)("div",Q,[(0,t.Wm)(z.Z,{tabla:v.value,style:{flex:"0 0 75%"}},null,8,["tabla"]),(0,t._)("div",J,[(0,t._)("span",null,"Importe introducido : "+(0,l.zw)(r.value),1),(0,t._)("span",null,"Importe total: "+(0,l.zw)(c.value),1),(0,t._)("span",null,"Importe falta devolver: "+(0,l.zw)(n.value),1),(0,t.Wm)((0,M.SU)(E.$v),{disabled:s.value,onClick:k,color:"success",class:"boton-Cashlogy"},{default:(0,t.w5)((()=>[(0,t.Uk)(" Aceptar ")])),_:1},8,["disabled"])])])):(0,t.kq)("",!0),"SOLO_DISPENSAR"==_.value?((0,t.wg)(),(0,t.iD)("div",K,[(0,t._)("div",null,[(0,t.Uk)(" Dispensando"),X,(0,t.Uk)(" Importe a devolver: "+(0,l.zw)(n.value),1)])])):(0,t.kq)("",!0),"ERROR_DEVOLUCION"==_.value?((0,t.wg)(),(0,t.j4)(L.Z,{key:4,ref_key:"CashlogyErrorDevolucion_ref",ref:i},null,512)):(0,t.kq)("",!0)])),_:1},8,["enProceso"]))}};const ea=aa;var oa=ea,ta=o(49242);const la={class:"mb-0 mt-2"},ia=(0,t._)("p",{class:"mb-0 mt-2"},"Motivo de anulación:",-1),na={key:0,class:"text-danger mt-2"};function ra(a,e,o,i,n,r){const c=(0,t.up)("MDBIcon"),s=(0,t.up)("MDBModalTitle"),u=(0,t.up)("MDBModalHeader"),d=(0,t.up)("MDBModalBody"),v=(0,t.up)("MDBBtn"),m=(0,t.up)("MDBModalFooter"),p=(0,t.up)("MDBModal"),k=(0,t.up)("KeyBoardComponentVue");return(0,t.wg)(),(0,t.iD)(t.HY,null,[(0,t.Wm)(p,{id:"modalAnulacionTicket",tabindex:"-1",labelledby:"tituloModalAnulacionTicket",modelValue:i.modalAnulacionTicket,"onUpdate:modelValue":e[2]||(e[2]=a=>i.modalAnulacionTicket=a),staticBackdrop:""},{default:(0,t.w5)((()=>[(0,t.Wm)(u,{onClose:a=>!1},{default:(0,t.w5)((()=>[(0,t.Wm)(c,{fas:"",icon:"exclamation-circle",class:"text-warning me-2"}),(0,t.Wm)(s,null,{default:(0,t.w5)((()=>[(0,t.Uk)("Anulación de ticket")])),_:1})])),_:1}),(0,t.Wm)(d,null,{default:(0,t.w5)((()=>[(0,t._)("p",la,"Ticket: "+(0,l.zw)(i.idTicket),1),ia,(0,t.wy)((0,t._)("textarea",{"onUpdate:modelValue":e[0]||(e[0]=a=>i.reason=a),class:"form-control",rows:"3",placeholder:"...",onClick:e[1]||(e[1]=a=>{i.showValidationMessage=!1,i.openKeyboard()}),readonly:""},null,512),[[ta.nr,i.reason]]),i.showValidationMessage?((0,t.wg)(),(0,t.iD)("p",na," Debes escribir un motivo de anulación ")):(0,t.kq)("",!0)])),_:1}),(0,t.Wm)(m,null,{default:(0,t.w5)((()=>[(0,t.Wm)(v,{color:"secondary",onClick:i.onCancel},{default:(0,t.w5)((()=>[(0,t.Uk)(" Cancelar ")])),_:1},8,["onClick"]),(0,t.Wm)(v,{color:"primary",onClick:i.onConfirm,disabled:i.isLoading},{default:(0,t.w5)((()=>[(0,t.Uk)(" Confirmar ")])),_:1},8,["onClick","disabled"])])),_:1})])),_:1},8,["modelValue"]),(0,t.Wm)(k,{ref:"keyboardRef"},null,512)],64)}var ca=o(78400),sa={name:"modalAnulacionTicketComponent",components:{MDBModal:E.j3,MDBModalHeader:E.ol,MDBModalTitle:E.wo,MDBModalBody:E.Yz,MDBModalFooter:E.ab,MDBBtn:E.$v,KeyBoardComponentVue:ca.Z,MDBIcon:E.vm},setup(a,{expose:e,emit:o}){const t=(0,M.iH)(!1),l=(0,M.iH)(null),i=(0,M.iH)(""),n=(0,M.iH)(!1),r=(0,M.iH)(!1),c=(0,M.iH)(null);function s(a=null){t.value=!0,l.value=a}const u=()=>{v()},d=()=>{0!==i.value.length?(n.value=!1,r.value=!0,o("anularTicket",l.value,i.value),setTimeout((()=>{r.value=!1}),1500),v()):n.value=!0},v=()=>{t.value=!1,i.value=""};let m;const p=async()=>{try{c.value.abrirModal(i.value),m=setInterval((()=>{i.value=c.value.getValue()[0],c.value.getValue()[1]||clearInterval(m)}),100)}catch(a){console.log(a),m=void 0}};return e({openModal:s}),{modalAnulacionTicket:t,idTicket:l,reason:i,showValidationMessage:n,isLoading:r,keyboardRef:c,openKeyboard:p,onCancel:u,onConfirm:d,closeModal:v}}},ua=o(40089);const da=(0,ua.Z)(sa,[["render",ra]]);var va=da,ma={name:"TicketsComponent",components:{MDBTable:E.re,MDBBtn:E.$v,MDBIcon:E.vm,ModalErrorDatafonoComponent:N.Z,CashlogyAnulacionView:oa,ModalAnulacionTicket:va},setup(a){const e=(0,x.oR)(),o=(0,M.iH)(null),l=(0,M.iH)(!1),i=(0,M.iH)(!1),n=(0,M.iH)(!1),r=(0,M.iH)(null),c=(0,M.iH)(!0),s=(e.getters["Configuracion/parametros"],(0,t.Fl)((()=>e.state.Trabajadores.arrayTrabajadores))),u=(0,t.Fl)((()=>e.state.Trabajadores.indexActivo)),d=(0,t.Fl)((()=>s.value&&void 0!=u.value&&null!=u.value&&s.value[u.value]?s.value[u.value]:null)),v=(0,t.Fl)((()=>e.state.Caja.arrayVentas));(0,t.YP)(v,((a,e)=>{let t=null;for(let l=0;l<a.length;l++)if(a[l]._id===o.value){t=l;break}r.value=t}));const m=(0,M.iH)(null),p=(0,M.iH)(null),k=(0,M.iH)(!1),_=(0,M.iH)(null);function f(a){const e=new Date(a);return P()(e).format("HH:mm:ss DD/MM/YYYY")}function T(a=null){const e=a||v.value[r.value]._id;O.Z.post("impresora/imprimirTicket",{idTicket:e}).catch((a=>{R().fire("Oops...",a.message,"error")}))}function g(){O.Z.post("impresora/imprimirTicketPaytef",{idTicket:v.value[r.value]._id}).catch((a=>{R().fire("Oops...",a.message,"error")}))}function w(a,e){o.value=a._id,r.value=e}function A(a){O.Z.post("/movimientos/PayWithCash",{idTicket:a}).then((a=>{o.value=null,r.value=null,H.Z.push("/main")})).catch((a=>{console.log(a)}))}async function y(a){function t(){O.Z.post("/movimientos/PayWith3G",{idTicket:a}).then((a=>{})).catch((a=>{console.log(a)}))}function l(){e.dispatch("Datafono/setEstado","PENDIENTE"),I.socket.emit("iniciarTransaccion",{idTicket:a,idTrabajador:d.value._id})}await O.Z.post("parametros/getParametros").then((a=>{"3G"===a.data?.tipoDatafono||"0.0.0.0"==a.data?.ipTefpay?t():l()})),o.value=null,r.value=null,H.Z.push("/main")}function C(a){a&&(n.value?_.value.openModal(a):h())}function h(){confirm("¿Confirma ANULACIÓN de ticket?")&&b()}async function b(a=null,e=null){if(null!=r.value)if("DEUDA"!=v.value[r.value].tipoPago){k.value=!0;let t=!1,l=a||v.value[r.value]._id;if("EFECTIVO"==v.value[r.value].tipoPago&&await p.value.activado())try{if((await O.Z.post("tickets/isTicketAnulable",{ticketId:l})).data){let a=await p.value.run(v.value[r.value].total);a.cancelado&&(t=!0)}}catch(o){R().fire(o.message)}t?k.value=!1:O.Z.post("tickets/anularTicket",{ticketId:l,reason:e},{headers:{"Content-Type":"application/json"}}).then((a=>{z(a)})).catch((a=>{R().fire("Error al anular ticket")})).finally((()=>{k.value=!1}))}else O.Z.post("deudas/getDeudaByIdTicket",{idTicket:v.value[r.value]._id,timestamp:v.value[r.value].timestamp}).then((a=>{let e=0;v.value[r.value].movimientos.length>0&&(e=v.value[r.value].movimientos.length-1),a&&(""==a.data&&"DEUDA"==v.value[r.value].movimientos[e].tipo||"SIN_PAGAR"==a.data.estado)?R().fire({icon:"info",title:"No se puede anular la deuda desde tickets",showConfirmButton:!0}):a&&""==a.data?R().fire({icon:"info",title:"Deuda ya saldada",showConfirmButton:!0}):a.data&&""!=a.data&&"ANULADO"==a.data.estado?R().fire({icon:"info",title:"Este ticket ya se ha anulado en deudas",showConfirmButton:!0}):"PAGADO"==a.data.estado&&R().fire({icon:"info",title:"Este ticket ya se ha pagado, Num ticket: "+a.data.idTicket,showConfirmButton:!0})})).catch((a=>{R().fire(a.message)}));else R().fire("Primero selecciona el ticket")}function E(){R().fire({icon:"success",title:B,showConfirmButton:!1,timer:1200})}const B="Ticket anulado",U="Ya esta anulado";function N(a){R().fire({icon:"error",title:a,showConfirmButton:!1,timer:1400})}function z(a){const e=a.data.res;if(e)n.value&&T(a.data.idTicket),["TARJETA"].includes(a.data.tipo)?H.Z.push("/main"):E();else if(!a.data.res){const e="TARJETA"===a.data.tipo?a.data.msg:U;N(e)}}function L(a){H.Z.push(a)}return(0,t.bv)((async()=>{D.W.cargarVentas();const{data:a}=await O.Z.post("parametros/getParametros");l.value="Si"==a.params?.ProhibirAnulacioTicket,i.value="Si"==a.params?.prohibirAnular3g,n.value="Si"==a.params?.JustificarAnul,v.value&&v.value.length>0&&w(v.value[0],0)})),{modalErrorDatafonoRef:m,arrayTickets:v,getTiempo:f,setActivo:w,idActivo:o,cambiarTipoPago:y,imprimirTicket:T,esborrarTicket:b,prohibirAnularTicket:l,goTo:L,pagarEfectivo:A,prohibirAnular3g:i,indexTicket:r,imprimirTicketPaytef:g,mostrarPorAlbaran:c,CashlogyAnulacionViewRef:p,anulando:k,modalAnulacionTicketRef:_,openModalAnulacion:C}}};const pa=(0,ua.Z)(ma,[["render",b],["__scopeId","data-v-61a97d2f"]]);var ka=pa}}]);
//# sourceMappingURL=509.177b762c.js.map